/**
 * yjs - A framework for real-time p2p shared editing on any data
 * @version v13.0.0-3
 * @license MIT
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.Y=t()}(this,function(){"use strict";function e(e,t){return t={exports:{}},e(t,t.exports),t.exports}function t(e){if(e=String(e),!(e.length>100)){var t=/^((?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|years?|yrs?|y)?$/i.exec(e);if(t){var r=parseFloat(t[1]);switch((t[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return r*I;case"days":case"day":case"d":return r*Y;case"hours":case"hour":case"hrs":case"hr":case"h":return r*O;case"minutes":case"minute":case"mins":case"min":case"m":return r*w;case"seconds":case"second":case"secs":case"sec":case"s":return r*m;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return r;default:return}}}}function r(e){return e>=Y?Math.round(e/Y)+"d":e>=O?Math.round(e/O)+"h":e>=w?Math.round(e/w)+"m":e>=m?Math.round(e/m)+"s":e+"ms"}function n(e){return i(e,Y,"day")||i(e,O,"hour")||i(e,w,"minute")||i(e,m,"second")||e+" ms"}function i(e,t,r){if(!(e<t))return e<1.5*t?Math.floor(e/t)+" "+r:Math.ceil(e/t)+" "+r+"s"}function s(e){return"read"===e||"write"===e}function a(e){return"write"===e}function o(e){var t;t=null===c.sourceDir?null:c.sourceDir||"/bower_components";for(var r=void 0!==x?".js":".es6",n=[],i=0;i<e.length;i++){var s=e[i].split("(")[0],a="y-"+s.toLowerCase();if(null==c[s])if(null==_[s])if("undefined"!=typeof window&&"undefined"!==window.Y){var o;!function(){null!=t&&(o=document.createElement("script"),o.src=t+"/"+a+"/"+a+r,document.head.appendChild(o));var e={};_[s]=e,e.promise=new Promise(function(t){e.resolve=t}),n.push(e.promise)}()}else console.info("YJS: Please do not depend on automatic requiring of modules anymore! Extend modules as follows `require('y-modulename')(Y)`"),require(a)(c);else n.push(_[e[i]].promise)}return Promise.all(n)}function c(e){e.hasOwnProperty("sourceDir")&&(c.sourceDir=e.sourceDir),e.types=null!=e.types?e.types:[];var t=[e.db.name,e.connector.name].concat(e.types);for(var r in e.share)t.push(e.share[r]);return new Promise(function(r,n){null==e?n(new Error("An options object is expected!")):null==e.connector?n(new Error("You must specify a connector! (missing connector property)")):null==e.connector.name?n(new Error("You must specify connector name! (missing connector.name property)")):null==e.db?n(new Error("You must specify a database! (missing db property)")):null==e.connector.name?n(new Error("You must specify db name! (missing db.name property)")):(e=c.utils.copyObject(e),e.connector=c.utils.copyObject(e.connector),e.db=c.utils.copyObject(e.db),e.share=c.utils.copyObject(e.share),c.requestModules(t).then(function(){var t=new E(e);t.db.whenUserIdSet(function(){t.init(function(){r(t)})})}).catch(n))})}var u="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},l="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},d=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},h=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),f=function e(t,r,n){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,r);if(void 0===i){var s=Object.getPrototypeOf(t);return null===s?void 0:e(s,r,n)}if("value"in i)return i.value;var a=i.get;if(void 0!==a)return a.call(n)},p=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},g=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},y=e(function(e){!function(t){function r(e,t,r,n){var s=t&&t.prototype instanceof i?t:i,a=Object.create(s.prototype),o=new p(n||[]);return a._invoke=u(e,r,o),a}function n(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}function i(){}function s(){}function a(){}function o(e){["next","throw","return"].forEach(function(t){e[t]=function(e){return this._invoke(t,e)}})}function c(e){function r(t,i,s,a){var o=n(e[t],e,i);if("throw"!==o.type){var c=o.arg,u=c.value;return u&&"object"===(void 0===u?"undefined":l(u))&&k.call(u,"__await")?Promise.resolve(u.__await).then(function(e){r("next",e,s,a)},function(e){r("throw",e,s,a)}):Promise.resolve(u).then(function(e){c.value=e,s(c)},a)}a(o.arg)}function i(e,t){function n(){return new Promise(function(n,i){r(e,t,n,i)})}return s=s?s.then(n,n):n()}"object"===l(t.process)&&t.process.domain&&(r=t.process.domain.bind(r));var s;this._invoke=i}function u(e,t,r){var i=I;return function(s,a){if(i===T)throw new Error("Generator is already running");if(i===C){if("throw"===s)throw a;return y()}for(r.method=s,r.arg=a;;){var o=r.delegate;if(o){var c=d(o,r);if(c){if(c===_)continue;return c}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(i===I)throw i=C,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);i=T;var u=n(e,t,r);if("normal"===u.type){if(i=r.done?C:S,u.arg===_)continue;return{value:u.arg,done:r.done}}"throw"===u.type&&(i=C,r.method="throw",r.arg=u.arg)}}}function d(e,t){var r=e.iterator[t.method];if(r===v){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=v,d(e,t),"throw"===t.method))return _;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return _}var i=n(r,e.iterator,t.arg);if("throw"===i.type)return t.method="throw",t.arg=i.arg,t.delegate=null,_;var s=i.arg;return s?s.done?(t[e.resultName]=s.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=v),t.delegate=null,_):s:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,_)}function h(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function f(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function p(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(h,this),this.reset(!0)}function g(e){if(e){var t=e[m];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var r=-1,n=function t(){for(;++r<e.length;)if(k.call(e,r))return t.value=e[r],t.done=!1,t;return t.value=v,t.done=!0,t};return n.next=n}}return{next:y}}function y(){return{value:v,done:!0}}var v,b=Object.prototype,k=b.hasOwnProperty,x="function"==typeof Symbol?Symbol:{},m=x.iterator||"@@iterator",w=x.asyncIterator||"@@asyncIterator",O=x.toStringTag||"@@toStringTag",Y=t.regeneratorRuntime;if(Y)return void(e.exports=Y);Y=t.regeneratorRuntime=e.exports,Y.wrap=r;var I="suspendedStart",S="suspendedYield",T="executing",C="completed",_={},E={};E[m]=function(){return this};var L=Object.getPrototypeOf,B=L&&L(L(g([])));B&&B!==b&&k.call(B,m)&&(E=B);var P=a.prototype=i.prototype=Object.create(E);s.prototype=P.constructor=a,a.constructor=s,a[O]=s.displayName="GeneratorFunction",Y.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===s||"GeneratorFunction"===(t.displayName||t.name))},Y.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,a):(e.__proto__=a,O in e||(e[O]="GeneratorFunction")),e.prototype=Object.create(P),e},Y.awrap=function(e){return{__await:e}},o(c.prototype),c.prototype[w]=function(){return this},Y.AsyncIterator=c,Y.async=function(e,t,n,i){var s=new c(r(e,t,n,i));return Y.isGeneratorFunction(t)?s:s.next().then(function(e){return e.done?e.value:s.next()})},o(P),P[O]="Generator",P[m]=function(){return this},P.toString=function(){return"[object Generator]"},Y.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},Y.values=g,p.prototype={constructor:p,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=v,this.done=!1,this.delegate=null,this.method="next",this.arg=v,this.tryEntries.forEach(f),!e)for(var t in this)"t"===t.charAt(0)&&k.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=v)},stop:function(){this.done=!0;var e=this.tryEntries[0],t=e.completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(e){function t(t,n){return s.type="throw",s.arg=e,r.next=t,n&&(r.method="next",r.arg=v),!!n}if(this.done)throw e;for(var r=this,n=this.tryEntries.length-1;n>=0;--n){var i=this.tryEntries[n],s=i.completion;if("root"===i.tryLoc)return t("end");if(i.tryLoc<=this.prev){var a=k.call(i,"catchLoc"),o=k.call(i,"finallyLoc");if(a&&o){if(this.prev<i.catchLoc)return t(i.catchLoc,!0);if(this.prev<i.finallyLoc)return t(i.finallyLoc)}else if(a){if(this.prev<i.catchLoc)return t(i.catchLoc,!0)}else{if(!o)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return t(i.finallyLoc)}}}},abrupt:function(e,t){for(var r=this.tryEntries.length-1;r>=0;--r){var n=this.tryEntries[r];if(n.tryLoc<=this.prev&&k.call(n,"finallyLoc")&&this.prev<n.finallyLoc){var i=n;break}}i&&("break"===e||"continue"===e)&&i.tryLoc<=t&&t<=i.finallyLoc&&(i=null);var s=i?i.completion:{};return s.type=e,s.arg=t,i?(this.method="next",this.next=i.finallyLoc,_):this.complete(s)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),_},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),f(r),_}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var i=n.arg;f(r)}return i}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:g(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=v),_}}}("object"===l(u)?u:"object"===("undefined"==typeof window?"undefined":l(window))?window:"object"===("undefined"==typeof self?"undefined":l(self))?self:u)}),v="object"===l(u)?u:"object"===("undefined"==typeof window?"undefined":l(window))?window:"object"===("undefined"==typeof self?"undefined":l(self))?self:u,b=v.regeneratorRuntime&&Object.getOwnPropertyNames(v).indexOf("regeneratorRuntime")>=0,k=b&&v.regeneratorRuntime;v.regeneratorRuntime=void 0;var x=y;if(b)v.regeneratorRuntime=k;else try{delete v.regeneratorRuntime}catch(e){v.regeneratorRuntime=void 0}var m=1e3,w=60*m,O=60*w,Y=24*O,I=365.25*Y,S=function(e,i){i=i||{};var s=void 0===e?"undefined":l(e);if("string"===s&&e.length>0)return t(e);if("number"===s&&!1===isNaN(e))return i.long?n(e):r(e);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(e))},T=e(function(e,t){function r(e){var r,n=0;for(r in e)n=(n<<5)-n+e.charCodeAt(r),n|=0;return t.colors[Math.abs(n)%t.colors.length]}function n(e){function n(){if(n.enabled){var e=n,r=+new Date,i=r-(c||r);e.diff=i,e.prev=c,e.curr=r,c=r;for(var s=new Array(arguments.length),a=0;a<s.length;a++)s[a]=arguments[a];s[0]=t.coerce(s[0]),"string"!=typeof s[0]&&s.unshift("%O");var o=0;s[0]=s[0].replace(/%([a-zA-Z%])/g,function(r,n){if("%%"===r)return r;o++;var i=t.formatters[n];if("function"==typeof i){var a=s[o];r=i.call(e,a),s.splice(o,1),o--}return r}),t.formatArgs.call(e,s);(n.log||t.log||console.log.bind(console)).apply(e,s)}}return n.namespace=e,n.enabled=t.enabled(e),n.useColors=t.useColors(),n.color=r(e),"function"==typeof t.init&&t.init(n),n}function i(e){t.save(e),t.names=[],t.skips=[];for(var r=("string"==typeof e?e:"").split(/[\s,]+/),n=r.length,i=0;i<n;i++)r[i]&&(e=r[i].replace(/\*/g,".*?"),"-"===e[0]?t.skips.push(new RegExp("^"+e.substr(1)+"$")):t.names.push(new RegExp("^"+e+"$")))}function s(){t.enable("")}function a(e){var r,n;for(r=0,n=t.skips.length;r<n;r++)if(t.skips[r].test(e))return!1;for(r=0,n=t.names.length;r<n;r++)if(t.names[r].test(e))return!0;return!1}function o(e){return e instanceof Error?e.stack||e.message:e}t=e.exports=n.debug=n.default=n,t.coerce=o,t.disable=s,t.enable=i,t.enabled=a,t.humanize=S,t.names=[],t.skips=[],t.formatters={};var c}),C=e(function(e,t){function r(){return!("undefined"==typeof window||!window.process||"renderer"!==window.process.type)||("undefined"!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/))}function n(e){var r=this.useColors;if(e[0]=(r?"%c":"")+this.namespace+(r?" %c":" ")+e[0]+(r?"%c ":" ")+"+"+t.humanize(this.diff),r){var n="color: "+this.color;e.splice(1,0,n,"color: inherit");var i=0,s=0;e[0].replace(/%[a-zA-Z%]/g,function(e){"%%"!==e&&(i++,"%c"===e&&(s=i))}),e.splice(s,0,n)}}function i(){return"object"===("undefined"==typeof console?"undefined":l(console))&&console.log&&Function.prototype.apply.call(console.log,console,arguments)}function s(e){try{null==e?t.storage.removeItem("debug"):t.storage.debug=e}catch(e){}}function a(){var e;try{e=t.storage.debug}catch(e){}return!e&&"undefined"!=typeof process&&"env"in process&&(e=process.env.DEBUG),e}t=e.exports=T,t.log=i,t.formatArgs=n,t.save=s,t.load=a,t.useColors=r,t.storage="undefined"!=typeof chrome&&void 0!==chrome.storage?chrome.storage.local:function(){try{return window.localStorage}catch(e){}}(),t.colors=["lightseagreen","forestgreen","goldenrod","dodgerblue","darkorchid","crimson"],t.formatters.j=function(e){try{return JSON.stringify(e)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}},t.enable(a())});!function(e){var t=function(){function t(r,n){if(d(this,t),this.y=r,null==n&&(n={}),this.preferUntransformed=n.preferUntransformed||!1,null==n.role||"master"===n.role)this.role="master";else{if("slave"!==n.role)throw new Error("Role must be either 'master' or 'slave'!");this.role="slave"}this.log=e.debug("y:connector"),this.logMessage=e.debug("y:connector-message"),this.y.db.forwardAppliedOperations=n.forwardAppliedOperations||!1,this.role=n.role,this.connections={},this.isSynced=!1,this.userEventListeners=[],this.whenSyncedListeners=[],this.currentSyncTarget=null,this.syncingClients=[],this.forwardToSyncingClients=!1!==n.forwardToSyncingClients,this.debug=!0===n.debug,this.broadcastOpBuffer=[],this.protocolVersion=11,this.authInfo=n.auth||null,this.checkAuth=n.checkAuth||function(){return Promise.resolve("write")},!1!==n.generateUserId&&this.setUserId(e.utils.generateGuid())}return h(t,[{key:"resetAuth",value:function(e){this.authInfo!==e&&(this.authInfo=e,this.broadcast({type:"auth",auth:this.authInfo}))}},{key:"reconnect",value:function(){return this.log("reconnecting.."),this.y.db.startGarbageCollector()}},{key:"disconnect",value:function(){return this.log("discronnecting.."),this.connections={},this.isSynced=!1,this.currentSyncTarget=null,this.syncingClients=[],this.whenSyncedListeners=[],this.y.db.stopGarbageCollector(),this.y.db.whenTransactionsFinished()}},{key:"repair",value:function(){this.log("Repairing the state of Yjs. This can happen if messages get lost, and Yjs detects that something is wrong. If this happens often, please report an issue here: https://github.com/y-js/yjs/issues");for(var e in this.connections)this.connections[e].isSynced=!1;this.isSynced=!1,this.currentSyncTarget=null,this.findNextSyncTarget()}},{key:"setUserId",value:function(e){return null==this.userId?(this.log('Set userId to "%s"',e),this.userId=e,this.y.db.setUserId(e)):null}},{key:"onUserEvent",value:function(e){this.userEventListeners.push(e)}},{key:"removeUserEventListener",value:function(e){this.userEventListeners=this.userEventListeners.filter(function(t){return e!==t})}},{key:"userLeft",value:function(e){if(null!=this.connections[e]){this.log("User left: %s",e),delete this.connections[e],e===this.currentSyncTarget&&(this.currentSyncTarget=null,this.findNextSyncTarget()),this.syncingClients=this.syncingClients.filter(function(t){return t!==e});var t=!0,r=!1,n=void 0;try{for(var i,s=this.userEventListeners[Symbol.iterator]();!(t=(i=s.next()).done);t=!0)(0,i.value)({action:"userLeft",user:e})}catch(e){r=!0,n=e}finally{try{!t&&s.return&&s.return()}finally{if(r)throw n}}}}},{key:"userJoined",value:function(e,t){if(null==t)throw new Error("You must specify the role of the joined user!");if(null!=this.connections[e])throw new Error("This user already joined!");this.log("User joined: %s",e),this.connections[e]={isSynced:!1,role:t};var r={};r.promise=new Promise(function(e){r.resolve=e}),this.connections[e].syncStep2=r;var n=!0,i=!1,s=void 0;try{for(var a,o=this.userEventListeners[Symbol.iterator]();!(n=(a=o.next()).done);n=!0)(0,a.value)({action:"userJoined",user:e,role:t})}catch(e){i=!0,s=e}finally{try{!n&&o.return&&o.return()}finally{if(i)throw s}}null==this.currentSyncTarget&&this.findNextSyncTarget()}},{key:"whenSynced",value:function(e){this.isSynced?e():this.whenSyncedListeners.push(e)}},{key:"findNextSyncTarget",value:function(){if(null==this.currentSyncTarget){var e=null;for(var t in this.connections)if(!this.connections[t].isSynced){e=t;break}var r=this;null!=e?(this.currentSyncTarget=e,this.y.db.requestTransaction(x.mark(function t(){var n,i;return x.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.delegateYield(this.getStateSet(),"t0",1);case 1:n=t.t0,i={type:"sync step 1",stateSet:n,protocolVersion:r.protocolVersion,auth:r.authInfo},r.preferUntransformed&&0===Object.keys(n).length&&(i.preferUntransformed=!0),r.send(e,i);case 5:case"end":return t.stop()}},t,this)}))):r.isSynced||this.y.db.requestTransaction(x.mark(function e(){var t,n,i,s,a,o;return x.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r.isSynced){e.next=22;break}for(r.isSynced=!0,t=!0,n=!1,i=void 0,e.prev=5,s=r.whenSyncedListeners[Symbol.iterator]();!(t=(a=s.next()).done);t=!0)(o=a.value)();e.next=13;break;case 9:e.prev=9,e.t0=e.catch(5),n=!0,i=e.t0;case 13:e.prev=13,e.prev=14,!t&&s.return&&s.return();case 16:if(e.prev=16,!n){e.next=19;break}throw i;case 19:return e.finish(16);case 20:return e.finish(13);case 21:r.whenSyncedListeners=[];case 22:case"end":return e.stop()}},e,this,[[5,9,13,21],[14,,16,20]])}))}}},{key:"send",value:function(e,t){this.log("Send '%s' to %s",t.type,e),this.logMessage("Message: %j",t)}},{key:"broadcast",value:function(e){this.log("Broadcast '%s'",e.type),this.logMessage("Message: %j",e)}},{key:"broadcastOps",value:function(t){function r(){n.broadcastOpBuffer.length>0&&(n.broadcast({type:"update",ops:n.broadcastOpBuffer}),n.broadcastOpBuffer=[])}t=t.map(function(t){return e.Struct[t.struct].encode(t)});var n=this;0===this.broadcastOpBuffer.length?(this.broadcastOpBuffer=t,this.y.db.whenTransactionsFinished().then(r)):this.broadcastOpBuffer=this.broadcastOpBuffer.concat(t)}},{key:"receiveMessage",value:function(e,t){var r=this;if(e===this.userId)return Promise.resolve();if(this.log("Receive '%s' from %s",t.type,e),this.logMessage("Message: %j",t),null!=t.protocolVersion&&t.protocolVersion!==this.protocolVersion)return this.log("You tried to sync with a yjs instance that has a different protocol version\n          (You: "+this.protocolVersion+", Client: "+t.protocolVersion+").\n          The sync was stopped. You need to upgrade your dependencies (especially Yjs & the Connector)!\n          "),this.send(e,{type:"sync stop",protocolVersion:this.protocolVersion}),Promise.reject(new Error("Incompatible protocol version"));if(null!=t.auth&&null!=this.connections[e]){var n=this.checkAuth(t.auth,this.y);this.connections[e].auth=n,n.then(function(t){var n=!0,i=!1,s=void 0;try{for(var a,o=r.userEventListeners[Symbol.iterator]();!(n=(a=o.next()).done);n=!0)(0,a.value)({action:"userAuthenticated",user:e,auth:t})}catch(e){i=!0,s=e}finally{try{!n&&o.return&&o.return()}finally{if(i)throw s}}})}else null!=this.connections[e]&&null==this.connections[e].auth&&(this.connections[e].auth=this.checkAuth(null,this.y));return null!=this.connections[e]&&null!=this.connections[e].auth?this.connections[e].auth.then(function(n){if("sync step 1"===t.type&&s(n)){var i=r,o=t,c=void 0;c="slave"===r.role?Promise.all(Object.keys(r.connections).map(function(e){return r.connections[e]}).filter(function(e){return"master"===e.role}).map(function(e){return e.syncStep2.promise})):Promise.resolve(),c.then(function(){r.y.db.requestTransaction(x.mark(function r(){var n,s,a;return x.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return r.delegateYield(this.getStateSet(),"t0",1);case 1:return n=r.t0,r.delegateYield(this.getDeleteSet(),"t1",3);case 3:if(s=r.t1,a={type:"sync step 2",stateSet:n,deleteSet:s,protocolVersion:this.protocolVersion,auth:this.authInfo},!0!==t.preferUntransformed||0!==Object.keys(o.stateSet).length){r.next=10;break}return r.delegateYield(this.getOperationsUntransformed(),"t2",7);case 7:a.osUntransformed=r.t2,r.next=12;break;case 10:return r.delegateYield(this.getOperations(o.stateSet),"t3",11);case 11:a.os=r.t3;case 12:i.send(e,a),this.forwardToSyncingClients?(i.syncingClients.push(e),setTimeout(function(){i.syncingClients=i.syncingClients.filter(function(t){return t!==e}),i.send(e,{type:"sync done"})},5e3)):i.send(e,{type:"sync done"});case 14:case"end":return r.stop()}},r,this)}))})}else{if("sync step 2"===t.type&&a(n)){var u=r.y.db,l=r.connections[e].syncStep2,d=t;return u.requestTransaction(x.mark(function e(){return x.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(null==d.osUntransformed){e.next=4;break}return e.delegateYield(this.applyOperationsUntransformed(d.osUntransformed,d.stateSet),"t0",2);case 2:e.next=5;break;case 4:this.store.apply(d.os);case 5:case"end":return e.stop()}},e,this)})),u.whenTransactionsFinished().then(function(){u.requestTransaction(x.mark(function e(){return x.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.delegateYield(this.applyDeleteSet(d.deleteSet),"t0",1);case 1:case"end":return e.stop()}},e,this)})),l.resolve()}),l.promise}if("sync done"===t.type){var h=r;r.connections[e].syncStep2.promise.then(function(){h._setSyncedWith(e)})}else if("update"===t.type&&a(n)){if(r.forwardToSyncingClients){var f=!0,p=!1,g=void 0;try{for(var y,v=r.syncingClients[Symbol.iterator]();!(f=(y=v.next()).done);f=!0){var b=y.value;r.send(b,t)}}catch(e){p=!0,g=e}finally{try{!f&&v.return&&v.return()}finally{if(p)throw g}}}if(r.y.db.forwardAppliedOperations){var k=t.ops.filter(function(e){return"Delete"===e.struct});k.length>0&&r.broadcastOps(k)}r.y.db.apply(t.ops)}}}):Promise.reject(new Error("Unable to deliver message"))}},{key:"_setSyncedWith",value:function(e){var t=this.connections[e];null!=t&&(t.isSynced=!0),e===this.currentSyncTarget&&(this.currentSyncTarget=null,this.findNextSyncTarget())}},{key:"parseMessageFromXml",value:function(e){function t(e){var n=!0,i=!1,s=void 0;try{for(var a,o=e.children[Symbol.iterator]();!(n=(a=o.next()).done);n=!0){var c=a.value;return"true"===c.getAttribute("isArray")?t(c):r(c)}}catch(e){i=!0,s=e}finally{try{!n&&o.return&&o.return()}finally{if(i)throw s}}}function r(e){var n={};for(var i in e.attrs){var s=e.attrs[i],a=parseInt(s,10);isNaN(a)||""+a!==s?n[i]=s:n[i]=a}for(var o in e.children){var c=o.name;"true"===o.getAttribute("isArray")?n[c]=t(o):n[c]=r(o)}return n}r(e)}},{key:"encodeMessageToXml",value:function(e,t){function r(e,t){for(var i in t){var s=t[i];null==i||(s.constructor===Object?r(e.c(i),s):s.constructor===Array?n(e.c(i),s):e.setAttribute(i,s))}}function n(e,t){e.setAttribute("isArray","true");var i=!0,s=!1,a=void 0;try{for(var o,c=t[Symbol.iterator]();!(i=(o=c.next()).done);i=!0){var u=o.value;u.constructor===Object?r(e.c("array-element"),u):n(e.c("array-element"),u)}}catch(e){s=!0,a=e}finally{try{!i&&c.return&&c.return()}finally{if(s)throw a}}}if(t.constructor===Object)r(e.c("y",{xmlns:"http://y.ninja/connector-stanza"}),t);else{if(t.constructor!==Array)throw new Error("I can't encode this json!");n(e.c("y",{xmlns:"http://y.ninja/connector-stanza"}),t)}}}]),t}();e.AbstractConnector=t}(c),function(e){var t=function(){function t(e,r){function n(){return i.whenTransactionsFinished().then(function(){return i.gcTimeout>0&&(i.gc1.length>0||i.gc2.length>0)?(i.y.connector.isSynced||console.warn("gc should be empty when not synced!"),new Promise(function(e){i.requestTransaction(x.mark(function t(){var r,s;return x.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(null==i.y.connector||!i.y.connector.isSynced){t.next=10;break}r=0;case 2:if(!(r<i.gc2.length)){t.next=8;break}return s=i.gc2[r],t.delegateYield(this.garbageCollectOperation(s),"t0",5);case 5:r++,t.next=2;break;case 8:i.gc2=i.gc1,i.gc1=[];case 10:i.gcTimeout>0&&(i.gcInterval=setTimeout(n,i.gcTimeout)),e();case 12:case"end":return t.stop()}},t,this)}))})):(i.gcTimeout>0&&(i.gcInterval=setTimeout(n,i.gcTimeout)),Promise.resolve())})}d(this,t),this.y=e,r.gc=!0===r.gc,this.dbOpts=r;var i=this;this.userId=null;var s;this.userIdPromise=new Promise(function(e){s=e}),this.userIdPromise.resolve=s,this.forwardAppliedOperations=!1,this.listenersById={},this.listenersByIdExecuteNow=[],this.listenersByIdRequestPending=!1,this.initializedTypes={},this.waitingTransactions=[],this.transactionInProgress=!1,this.transactionIsFlushed=!1,"undefined"!=typeof YConcurrencyTestingMode&&(this.executeOrder=[]),this.gc1=[],this.gc2=[],this.garbageCollect=n,this.startGarbageCollector(),this.repairCheckInterval=r.repairCheckInterval?r.repairCheckInterval:6e3,this.opsReceivedTimestamp=new Date,this.startRepairCheck()}return h(t,[{key:"startGarbageCollector",value:function(){this.gc=this.dbOpts.gc,this.gc?this.gcTimeout=this.dbOpts.gcTimeout?this.dbOpts.gcTimeout:1e5:this.gcTimeout=-1,this.gcTimeout>0&&this.garbageCollect()}},{key:"startRepairCheck",value:function(){var e=this;this.repairCheckInterval>0&&(this.repairCheckIntervalHandler=setInterval(function(){new Date-e.opsReceivedTimestamp>e.repairCheckInterval&&Object.keys(e.listenersById).length>0&&(e.listenersById={},e.opsReceivedTimestamp=new Date,e.y.connector.repair())},this.repairCheckInterval))}},{key:"stopRepairCheck",value:function(){clearInterval(this.repairCheckIntervalHandler)}},{key:"queueGarbageCollector",value:function(e){this.y.connector.isSynced&&this.gc&&this.gc1.push(e)}},{key:"emptyGarbageCollector",value:function(){var e=this;return new Promise(function(t){var r=function r(){e.gc1.length>0||e.gc2.length>0?e.garbageCollect().then(r):t()};setTimeout(r,0)})}},{key:"addToDebug",value:function(){if("undefined"!=typeof YConcurrencyTestingMode){var e=Array.prototype.map.call(arguments,function(e){return"string"==typeof e?e:JSON.stringify(e)}).join("").replace(/"/g,"'").replace(/,/g,", ").replace(/:/g,": ");this.executeOrder.push(e)}}},{key:"getDebugData",value:function(){console.log(this.executeOrder.join("\n"))}},{key:"stopGarbageCollector",value:function(){var e=this;return this.gc=!1,this.gcTimeout=-1,new Promise(function(t){e.requestTransaction(x.mark(function r(){var n,i,s;return x.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:n=e.gc1.concat(e.gc2),e.gc1=[],e.gc2=[],i=0;case 4:if(!(i<n.length)){r.next=13;break}return r.delegateYield(this.getOperation(n[i]),"t0",6);case 6:if(null==(s=r.t0)){r.next=10;break}return delete s.gc,r.delegateYield(this.setOperation(s),"t1",10);case 10:i++,r.next=4;break;case 13:t();case 14:case"end":return r.stop()}},r,this)}))})}},{key:"addToGarbageCollector",value:x.mark(function e(t,r){var n;return x.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(null!=t.gc||!0!==t.deleted||!this.store.gc||!this.store.y.connector.isSynced){e.next=15;break}if(n=!1,null==r||!0!==r.deleted){e.next=6;break}n=!0,e.next=10;break;case 6:if(!(null!=t.content&&t.content.length>1)){e.next=10;break}return e.delegateYield(this.getInsertionCleanStart([t.id[0],t.id[1]+1]),"t0",8);case 8:t=e.t0,n=!0;case 10:if(!n){e.next=15;break}return t.gc=!0,e.delegateYield(this.setOperation(t),"t1",13);case 13:return this.store.queueGarbageCollector(t.id),e.abrupt("return",!0);case 15:return e.abrupt("return",!1);case 16:case"end":return e.stop()}},e,this)})},{key:"removeFromGarbageCollector",value:function(t){function r(r){return!e.utils.compareIds(r,t.id)}this.gc1=this.gc1.filter(r),this.gc2=this.gc2.filter(r),delete t.gc}},{key:"destroyTypes",value:function(){for(var e in this.initializedTypes){var t=this.initializedTypes[e];null!=t._destroy?t._destroy():console.error("The type you included does not provide destroy functionality, it will remain in memory (updating your packages will help).")}}},{key:"destroy",value:x.mark(function e(){return x.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:clearTimeout(this.gcInterval),this.gcInterval=null,this.stopRepairCheck();case 3:case"end":return e.stop()}},e,this)})},{key:"setUserId",value:function(e){if(!this.userIdPromise.inProgress){this.userIdPromise.inProgress=!0;var t=this;t.requestTransaction(x.mark(function r(){var n;return x.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return t.userId=e,r.delegateYield(this.getState(e),"t0",2);case 2:n=r.t0,t.opClock=n.clock,t.userIdPromise.resolve(e);case 5:case"end":return r.stop()}},r,this)}))}return this.userIdPromise}},{key:"whenUserIdSet",value:function(e){this.userIdPromise.then(e)}},{key:"getNextOpId",value:function(e){if(null==e)throw new Error("getNextOpId expects the number of created ids to create!");if(null==this.userId)throw new Error("OperationStore not yet initialized!");var t=[this.userId,this.opClock];return this.opClock+=e,t}},{key:"apply",value:function(t){this.opsReceivedTimestamp=new Date;for(var r=0;r<t.length;r++){var n=t[r];if(null==n.id||n.id[0]!==this.y.connector.userId){var i=e.Struct[n.struct].requiredOps(n);null!=n.requires&&(i=i.concat(n.requires)),this.whenOperationsExist(i,n)}}}},{key:"whenOperationsExist",value:function(e,t){if(e.length>0)for(var r={op:t,missing:e.length},n=0;n<e.length;n++){var i=e[n],s=JSON.stringify(i),a=this.listenersById[s];null==a&&(a=[],this.listenersById[s]=a),a.push(r)}else this.listenersByIdExecuteNow.push({op:t});if(!this.listenersByIdRequestPending){this.listenersByIdRequestPending=!0;var o=this;this.requestTransaction(x.mark(function e(){var t,r,n,i,s,a,c,u,l,d,h;return x.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:t=o.listenersByIdExecuteNow,o.listenersByIdExecuteNow=[],r=o.listenersById,o.listenersById={},o.listenersByIdRequestPending=!1,n=0;case 6:if(!(n<t.length)){e.next=12;break}return i=t[n].op,e.delegateYield(o.tryExecute.call(this,i),"t0",9);case 9:n++,e.next=6;break;case 12:e.t1=x.keys(r);case 13:if((e.t2=e.t1()).done){e.next=39;break}if(s=e.t2.value,a=r[s],c=JSON.parse(s),"string"!=typeof c[1]){e.next=22;break}return e.delegateYield(this.getOperation(c),"t3",19);case 19:u=e.t3,e.next=24;break;case 22:return e.delegateYield(this.getInsertion(c),"t4",23);case 23:u=e.t4;case 24:if(null!=u){e.next=28;break}o.listenersById[s]=a,e.next=37;break;case 28:l=0;case 29:if(!(l<a.length)){e.next=37;break}if(d=a[l],h=d.op,0!=--d.missing){e.next=34;break}return e.delegateYield(o.tryExecute.call(this,h),"t5",34);case 34:l++,e.next=29;break;case 37:e.next=13;break;case 39:case"end":return e.stop()}},e,this)}))}}},{key:"tryExecute",value:x.mark(function t(r){var n,i,s,a
;return x.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(this.store.addToDebug("yield * this.store.tryExecute.call(this, ",JSON.stringify(r),")"),"Delete"!==r.struct){t.next=5;break}return t.delegateYield(e.Struct.Delete.execute.call(this,r),"t0",3);case 3:t.next=32;break;case 5:return t.delegateYield(this.getInsertion(r.id),"t1",6);case 6:n=t.t1;case 7:if(null==n||null==n.content){t.next=21;break}if(!(n.id[1]+n.content.length<r.id[1]+r.content.length)){t.next=18;break}return i=n.content.length-(r.id[1]-n.id[1]),r.content.splice(0,i),r.id=[r.id[0],r.id[1]+i],r.left=e.utils.getLastId(n),r.origin=r.left,t.delegateYield(this.getOperation(r.id),"t2",15);case 15:n=t.t2,t.next=19;break;case 18:return t.abrupt("break",21);case 19:t.next=7;break;case 21:if(null!=n){t.next=32;break}return s=r.id,t.delegateYield(this.isGarbageCollected(s),"t3",24);case 24:if(a=t.t3){t.next=32;break}return t.delegateYield(e.Struct[r.struct].execute.call(this,r),"t4",27);case 27:return t.delegateYield(this.addOperation(r),"t5",28);case 28:return t.delegateYield(this.store.operationAdded(this,r),"t6",29);case 29:return t.delegateYield(this.getOperation(s),"t7",30);case 30:return r=t.t7,t.delegateYield(this.tryCombineWithLeft(r),"t8",32);case 32:case"end":return t.stop()}},t,this)})},{key:"operationAdded",value:x.mark(function t(r,n){var i,s,a,o,c,u,l,d,h,f,p,g,y,v,b,k;return x.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if("Delete"!==n.struct){t.next=6;break}if(null==(i=this.initializedTypes[JSON.stringify(n.targetParent)])){t.next=4;break}return t.delegateYield(i._changed(r,n),"t0",4);case 4:t.next=33;break;case 6:return t.delegateYield(r.updateState(n.id[0]),"t1",7);case 7:for(s=null!=n.content?n.content.length:1,a=0;a<s;a++)if(o=JSON.stringify([n.id[0],n.id[1]+a]),c=this.listenersById[o],delete this.listenersById[o],null!=c)for(u in c)l=c[u],0==--l.missing&&this.whenOperationsExist([],l.op);if(d=this.initializedTypes[JSON.stringify(n.parent)],null==n.parent){t.next=16;break}return t.delegateYield(r.isDeleted(n.parent),"t2",12);case 12:if(!(h=t.t2)){t.next=16;break}return t.delegateYield(r.deleteList(n.id),"t3",15);case 15:return t.abrupt("return");case 16:if(null==d){t.next=19;break}return f=e.utils.copyOperation(n),t.delegateYield(d._changed(r,f),"t4",19);case 19:if(n.deleted){t.next=33;break}p=null!=n.content?n.content.length:1,g=n.id,y=0;case 23:if(!(y<p)){t.next=33;break}return v=[g[0],g[1]+y],t.delegateYield(r.isDeleted(v),"t5",26);case 26:if(!(b=t.t5)){t.next=30;break}return k={struct:"Delete",target:v},t.delegateYield(this.tryExecute.call(r,k),"t6",30);case 30:y++,t.next=23;break;case 33:case"end":return t.stop()}},t,this)})},{key:"whenTransactionsFinished",value:function(){if(this.transactionInProgress){if(null==this.transactionsFinished){var e,t=new Promise(function(t){e=t});this.transactionsFinished={resolve:e,promise:t}}return this.transactionsFinished.promise}return Promise.resolve()}},{key:"getNextRequest",value:function(){return 0===this.waitingTransactions.length?this.transactionIsFlushed?(this.transactionInProgress=!1,this.transactionIsFlushed=!1,null!=this.transactionsFinished&&(this.transactionsFinished.resolve(),this.transactionsFinished=null),null):(this.transactionIsFlushed=!0,x.mark(function e(){return x.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.delegateYield(this.flush(),"t0",1);case 1:case"end":return e.stop()}},e,this)})):(this.transactionIsFlushed=!1,this.waitingTransactions.shift())}},{key:"requestTransaction",value:function(e,t){var r=this;this.waitingTransactions.push(e),this.transactionInProgress||(this.transactionInProgress=!0,setTimeout(function(){r.transact(r.getNextRequest())},0))}},{key:"getType",value:function(e){return this.initializedTypes[JSON.stringify(e)]}},{key:"initType",value:x.mark(function t(r,n){var i,s,a;return x.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(i=JSON.stringify(r),null!=(s=this.store.initializedTypes[i])){t.next=9;break}return t.delegateYield(this.getOperation(r),"t0",4);case 4:if(null==(a=t.t0)){t.next=9;break}return t.delegateYield(e[a.type].typeDefinition.initType.call(this,this.store,a,n),"t1",7);case 7:s=t.t1,this.store.initializedTypes[i]=s;case 9:return t.abrupt("return",s);case 10:case"end":return t.stop()}},t,this)})},{key:"createType",value:function(t,r){var n=t[0].struct;r=r||this.getNextOpId(1);var i=e.Struct[n].create(r);i.type=t[0].name,this.requestTransaction(x.mark(function e(){return x.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if("_"!==i.id[0]){e.next=4;break}return e.delegateYield(this.setOperation(i),"t0",2);case 2:e.next=5;break;case 4:return e.delegateYield(this.applyCreatedOperations([i]),"t1",5);case 5:case"end":return e.stop()}},e,this)}));var s=e[i.type].typeDefinition.createType(this,i,t[1]);return this.initializedTypes[JSON.stringify(i.id)]=s,s}}]),t}();e.AbstractDatabase=t}(c),function(e){var t=function(){function t(){d(this,t)}return h(t,[{key:"applyCreatedOperations",value:x.mark(function t(r){var n,i,s;return x.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:n=[],i=0;case 2:if(!(i<r.length)){t.next=9;break}return s=r[i],t.delegateYield(this.store.tryExecute.call(this,s),"t0",5);case 5:null!=s.id&&"string"==typeof s.id[1]||n.push(e.Struct[s.struct].encode(s));case 6:i++,t.next=2;break;case 9:this.store.y.connector.isSynced&&n.length>0&&this.store.y.connector.broadcastOps(n);case 10:case"end":return t.stop()}},t,this)})},{key:"deleteList",value:x.mark(function e(t){var r;return x.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(null==t){e.next=15;break}return e.delegateYield(this.getOperation(t),"t0",2);case 2:if(t=e.t0,t.gc){e.next=12;break}return t.gc=!0,t.deleted=!0,e.delegateYield(this.setOperation(t),"t1",7);case 7:return r=null!=t.content?t.content.length:1,e.delegateYield(this.markDeleted(t.id,r),"t2",9);case 9:if(null==t.opContent){e.next=11;break}return e.delegateYield(this.deleteOperation(t.opContent),"t3",11);case 11:this.store.queueGarbageCollector(t.id);case 12:t=t.right,e.next=0;break;case 15:case"end":return e.stop()}},e,this)})},{key:"deleteOperation",value:x.mark(function e(t,r,n){var i,s,a,o,c,u,l;return x.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return null==r&&(r=1),e.delegateYield(this.markDeleted(t,r),"t0",2);case 2:if(!(r>0)){e.next=64;break}return i=!1,e.delegateYield(this.os.findWithUpperBound([t[0],t[1]+r-1]),"t1",5);case 5:if(s=e.t1,a=null!=s&&null!=s.content?s.content.length:1,!(null==s||s.id[0]!==t[0]||s.id[1]+a<=t[1])){e.next=12;break}s=null,r=0,e.next=22;break;case 12:if(s.deleted){e.next=21;break}if(!(s.id[1]<t[1])){e.next=17;break}return e.delegateYield(this.getInsertionCleanStart(t),"t2",15);case 15:s=e.t2,a=s.content.length;case 17:if(!(s.id[1]+a>t[1]+r)){e.next=21;break}return e.delegateYield(this.getInsertionCleanEnd([t[0],t[1]+r-1]),"t3",19);case 19:s=e.t3,a=s.content.length;case 21:r=s.id[1]-t[1];case 22:if(null==s){e.next=62;break}if(s.deleted){e.next=44;break}if(i=!0,s.deleted=!0,null==s.start){e.next=28;break}return e.delegateYield(this.deleteList(s.start),"t4",28);case 28:if(null==s.map){e.next=35;break}e.t5=x.keys(s.map);case 30:if((e.t6=e.t5()).done){e.next=35;break}return o=e.t6.value,e.delegateYield(this.deleteList(s.map[o]),"t7",33);case 33:e.next=30;break;case 35:if(null==s.opContent){e.next=37;break}return e.delegateYield(this.deleteOperation(s.opContent),"t8",37);case 37:if(null==s.requires){e.next=44;break}c=0;case 39:if(!(c<s.requires.length)){e.next=44;break}return e.delegateYield(this.deleteOperation(s.requires[c]),"t9",41);case 41:c++,e.next=39;break;case 44:if(null==s.left){e.next=49;break}return e.delegateYield(this.getInsertion(s.left),"t10",46);case 46:u=e.t10,e.next=50;break;case 49:u=null;case 50:return e.delegateYield(this.setOperation(s),"t11",51);case 51:if(null==s.right){e.next=56;break}return e.delegateYield(this.getOperation(s.right),"t12",53);case 53:l=e.t12,e.next=57;break;case 56:l=null;case 57:if(!i||n){e.next=59;break}return e.delegateYield(this.store.operationAdded(this,{struct:"Delete",target:s.id,length:a,targetParent:s.parent}),"t13",59);case 59:return e.delegateYield(this.store.addToGarbageCollector.call(this,s,u),"t14",60);case 60:if(null==l){e.next=62;break}return e.delegateYield(this.store.addToGarbageCollector.call(this,l,s),"t15",62);case 62:e.next=2;break;case 64:case"end":return e.stop()}},e,this)})},{key:"markGarbageCollected",value:x.mark(function t(r,n){var i,s,a,o;return x.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return this.store.addToDebug("yield * this.markGarbageCollected(",r,", ",n,")"),t.delegateYield(this.markDeleted(r,n),"t0",2);case 2:if(i=t.t0,!(i.id[1]<r[1])||i.gc){t.next=9;break}return s=i.len-(r[1]-i.id[1]),i.len-=s,t.delegateYield(this.ds.put(i),"t1",7);case 7:return i={id:r,len:s,gc:!1},t.delegateYield(this.ds.put(i),"t2",9);case 9:return t.delegateYield(this.ds.findPrev(r),"t3",10);case 10:return a=t.t3,t.delegateYield(this.ds.findNext(r),"t4",12);case 12:if(o=t.t4,!(r[1]+n<i.id[1]+i.len)||i.gc){t.next=16;break}return t.delegateYield(this.ds.put({id:[r[0],r[1]+n],len:i.len-n,gc:!1}),"t5",15);case 15:i.len=n;case 16:if(i.gc=!0,null==a||!a.gc||!e.utils.compareIds([a.id[0],a.id[1]+a.len],i.id)){t.next=21;break}return a.len+=i.len,t.delegateYield(this.ds.delete(i.id),"t6",20);case 20:i=a;case 21:if(null==o||!o.gc||!e.utils.compareIds([i.id[0],i.id[1]+i.len],o.id)){t.next=24;break}return i.len+=o.len,t.delegateYield(this.ds.delete(o.id),"t7",24);case 24:return t.delegateYield(this.ds.put(i),"t8",25);case 25:return t.delegateYield(this.updateState(i.id[0]),"t9",26);case 26:case"end":return t.stop()}},t,this)})},{key:"markDeleted",value:x.mark(function e(t,r){var n,i,s,a;return x.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return null==r&&(r=1),e.delegateYield(this.ds.findWithUpperBound(t),"t0",2);case 2:if(null==(n=e.t0)||n.id[0]!==t[0]){e.next=27;break}if(!(n.id[1]<=t[1]&&t[1]<=n.id[1]+n.len)){e.next=23;break}if(!((i=t[1]+r-(n.id[1]+n.len))>0)){e.next=20;break}if(n.gc){e.next=11;break}n.len+=i,e.next=18;break;case 11:if(!((i=n.id[1]+n.len-t[1])<r)){e.next=17;break}return n={id:[t[0],t[1]+i],len:r-i,gc:!1},e.delegateYield(this.ds.put(n),"t1",15);case 15:e.next=18;break;case 17:throw new Error("DS reached an inconsistent state. Please report this issue!");case 18:e.next=21;break;case 20:return e.abrupt("return",n);case 21:e.next=25;break;case 23:return n={id:t,len:r,gc:!1},e.delegateYield(this.ds.put(n),"t2",25);case 25:e.next=29;break;case 27:return n={id:t,len:r,gc:!1},e.delegateYield(this.ds.put(n),"t3",29);case 29:return e.delegateYield(this.ds.findNext(n.id),"t4",30);case 30:if(!(null!=(s=e.t4)&&n.id[0]===s.id[0]&&n.id[1]+n.len>=s.id[1])){e.next=61;break}i=n.id[1]+n.len-s.id[1];case 33:if(!(i>=0)){e.next=61;break}if(!s.gc){e.next=44;break}if(n.len-=i,!(i>=s.len)){e.next=41;break}if(!((i-=s.len)>0)){e.next=41;break}return e.delegateYield(this.ds.put(n),"t5",40);case 40:return e.delegateYield(this.markDeleted([s.id[0],s.id[1]+s.len],i),"t6",41);case 41:return e.abrupt("break",61);case 44:if(!(i>s.len)){e.next=56;break}return e.delegateYield(this.ds.findNext(s.id),"t7",46);case 46:return a=e.t7,e.delegateYield(this.ds.delete(s.id),"t8",48);case 48:if(null!=a&&n.id[0]===a.id[0]){e.next=52;break}return e.abrupt("break",61);case 52:s=a,i=n.id[1]+n.len-s.id[1];case 54:e.next=59;break;case 56:return n.len+=s.len-i,e.delegateYield(this.ds.delete(s.id),"t9",58);case 58:return e.abrupt("break",61);case 59:e.next=33;break;case 61:return e.delegateYield(this.ds.put(n),"t10",62);case 62:return e.abrupt("return",n);case 63:case"end":return e.stop()}},e,this)})},{key:"garbageCollectAfterSync",value:x.mark(function e(){return x.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if((this.store.gc1.length>0||this.store.gc2.length>0)&&console.warn("gc should be empty after sync"),this.store.gc){e.next=3;break}return e.abrupt("return");case 3:return e.delegateYield(this.os.iterate(this,null,null,x.mark(function e(t){var r,n,i;return x.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!t.gc){e.next=3;break}return delete t.gc,e.delegateYield(this.setOperation(t),"t0",3);case 3:if(null==t.parent){e.next=23;break}return e.delegateYield(this.isDeleted(t.parent),"t1",5);case 5:if(!(r=e.t1)){e.next=23;break}if(t.gc=!0,t.deleted){e.next=20;break}return e.delegateYield(this.markDeleted(t.id,null!=t.content?t.content.length:1),"t2",10);case 10:if(t.deleted=!0,null==t.opContent){e.next=13;break}return e.delegateYield(this.deleteOperation(t.opContent),"t3",13);case 13:if(null==t.requires){e.next=20;break}n=0;case 15:if(!(n<t.requires.length)){e.next=20;break}return e.delegateYield(this.deleteOperation(t.requires[n]),"t4",17);case 17:n++,e.next=15;break;case 20:return e.delegateYield(this.setOperation(t),"t5",21);case 21:return this.store.gc1.push(t.id),e.abrupt("return");case 23:if(!t.deleted){e.next=29;break}if(i=null,null==t.left){e.next=28;break}return e.delegateYield(this.getInsertion(t.left),"t6",27);case 27:i=e.t6;case 28:return e.delegateYield(this.store.addToGarbageCollector.call(this,t,i),"t7",29);case 29:case"end":return e.stop()}},e,this)})),"t0",4);case 4:case"end":return e.stop()}},e,this)})},{key:"garbageCollectOperation",value:x.mark(function t(r){var n,i,s,a,o,c,u,l,d,h,f,p,g;return x.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return this.store.addToDebug("yield * this.garbageCollectOperation(",r,")"),t.delegateYield(this.getOperation(r),"t0",2);case 2:return n=t.t0,t.delegateYield(this.markGarbageCollected(r,null!=n&&null!=n.content?n.content.length:1),"t1",4);case 4:if(null==n){t.next=67;break}i=[],null!=n.opContent&&i.push(n.opContent),null!=n.requires&&(i=i.concat(n.requires)),s=0;case 9:if(!(s<i.length)){t.next=26;break}return t.delegateYield(this.getOperation(i[s]),"t2",11);case 11:if(null==(a=t.t2)){t.next=22;break}if(a.deleted){t.next=17;break}return t.delegateYield(this.deleteOperation(a.id),"t3",15);case 15:return t.delegateYield(this.getOperation(a.id),"t4",16);case 16:a=t.t4;case 17:return a.gc=!0,t.delegateYield(this.setOperation(a),"t5",19);case 19:this.store.queueGarbageCollector(a.id),t.next=23;break;case 22:return t.delegateYield(this.markGarbageCollected(i[s],1),"t6",23);case 23:s++,t.next=9;break;case 26:if(null==n.left){t.next=31;break}return t.delegateYield(this.getInsertion(n.left),"t7",28);case 28:return o=t.t7,o.right=n.right,t.delegateYield(this.setOperation(o),"t8",31);case 31:if(null==n.right){t.next=53;break}return t.delegateYield(this.getOperation(n.right),"t9",33);case 33:return c=t.t9,c.left=n.left,t.delegateYield(this.setOperation(c),"t10",36);case 36:if(!(null!=n.originOf&&n.originOf.length>0)){t.next=53;break}u=n.left,t.t11=x.keys(n.originOf);case 39:if((t.t12=t.t11()).done){t.next=48;break}return l=t.t12.value,t.delegateYield(this.getOperation(n.originOf[l]),"t13",42);case 42:if(null==(d=t.t13)){t.next=46;break}return d.origin=u,t.delegateYield(this.setOperation(d),"t14",46);case 46:t.next=39;break;case 48:if(null==u){t.next=53;break}return t.delegateYield(this.getInsertion(u),"t15",50);case 50:return h=t.t15,null==h.originOf?h.originOf=n.originOf:h.originOf=n.originOf.concat(h.originOf),t.delegateYield(this.setOperation(h),"t16",53);case 53:if(null==n.origin){t.next=58;break}return t.delegateYield(this.getInsertion(n.origin),"t17",55);case 55:return f=t.t17,f.originOf=f.originOf.filter(function(t){return!e.utils.compareIds(r,t)}),t.delegateYield(this.setOperation(f),"t18",58);case 58:if(null==n.parent){t.next=61;break}return t.delegateYield(this.getOperation(n.parent),"t19",60);case 60:p=t.t19;case 61:if(null==p){t.next=66;break}if(g=!1,null!=n.parentSub?e.utils.compareIds(p.map[n.parentSub],n.id)&&(g=!0,null!=n.right?p.map[n.parentSub]=n.right:delete p.map[n.parentSub]):(e.utils.compareIds(p.start,n.id)&&(g=!0,p.start=n.right),e.utils.matchesId(n,p.end)&&(g=!0,p.end=n.left)),!g){t.next=66;break}return t.delegateYield(this.setOperation(p),"t20",66);case 66:return t.delegateYield(this.removeOperation(n.id),"t21",67);case 67:case"end":return t.stop()}},t,this)})},{key:"checkDeleteStoreForState",value:x.mark(function e(t){var r;return x.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.delegateYield(this.ds.findWithUpperBound([t.user,t.clock]),"t0",1);case 1:null!=(r=e.t0)&&r.id[0]===t.user&&r.gc&&(t.clock=Math.max(t.clock,r.id[1]+r.len));case 3:case"end":return e.stop()}},e,this)})},{key:"updateState",value:x.mark(function e(t){var r,n,i;return x.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.delegateYield(this.getState(t),"t0",1);case 1:return r=e.t0,e.delegateYield(this.checkDeleteStoreForState(r),"t1",3);case 3:return e.delegateYield(this.getInsertion([t,r.clock]),"t2",4);case 4:n=e.t2,i=null!=n&&null!=n.content?n.content.length:1;case 6:if(!(null!=n&&t===n.id[0]&&n.id[1]<=r.clock&&n.id[1]+i>r.clock)){e.next=14;break}return r.clock+=i,e.delegateYield(this.checkDeleteStoreForState(r),"t3",9);case 9:return e.delegateYield(this.os.findNext(n.id),"t4",10);case 10:n=e.t4,i=null!=n&&null!=n.content?n.content.length:1,e.next=6;break;case 14:return e.delegateYield(this.setState(r),"t5",15);case 15:case"end":return e.stop()}},e,this)})},{key:"applyDeleteSet",value:x.mark(function e(t){var r,n,i,s,a,o,c,u,l,d,h;return x.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:r=[],e.t0=x.keys(t);case 2:if((e.t1=e.t0()).done){e.next=11;break}return n=e.t1.value,i=t[n],s=0,a=i[s],e.delegateYield(this.ds.iterate(this,[n,0],[n,Number.MAX_VALUE],x.mark(function e(t){var o;return x.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(null==a){e.next=10;break}if(o=0,!(t.id[1]+t.len<=a[0])){e.next=6;break}return e.abrupt("break",10);case 6:a[0]<t.id[1]?(o=Math.min(t.id[1]-a[0],a[1]),r.push([n,a[0],o,a[2]])):(o=t.id[1]+t.len-a[0],a[2]&&!t.gc&&r.push([n,a[0],Math.min(o,a[1]),a[2]]));case 7:a[1]<=o?a=i[++s]:(a[0]=a[0]+o,a[1]=a[1]-o),e.next=0;break;case 10:case"end":return e.stop()}},e,this)})),"t2",8);case 8:for(;s<i.length;s++)a=i[s],r.push([n,a[0],a[1],a[2]]);e.next=2;break;case 11:o=0;case 12:if(!(o<r.length)){e.next=40;break}return c=r[o],e.delegateYield(this.deleteOperation([c[0],c[1]],c[2]),"t3",15);case 15:if(!c[3]){e.next=36;break}return e.delegateYield(this.markGarbageCollected([c[0],c[1]],c[2]),"t4",17);case 17:u=c[1]+c[2];case 18:if(!(u>=c[1])){e.next=36;break}return e.delegateYield(this.os.findWithUpperBound([c[0],u-1]),"t5",20);case 20:if(null!=(l=e.t5)){e.next=23;break}return e.abrupt("break",36);case 23:if(d=null!=l.content?l.content.length:1,!(l.id[0]!==c[0]||l.id[1]+d<=c[1])){e.next=26;break}return e.abrupt("break",36);case 26:if(!(l.id[1]+d>c[1]+c[2])){e.next=29;break}return e.delegateYield(this.getInsertionCleanEnd([c[0],c[1]+c[2]-1]),"t6",28);case 28:l=e.t6;case 29:if(!(l.id[1]<c[1])){e.next=32;break}return e.delegateYield(this.getInsertionCleanStart([c[0],c[1]]),"t7",31);case 31:l=e.t7;case 32:return u=l.id[1],e.delegateYield(this.garbageCollectOperation(l.id),"t8",34);case 34:e.next=18;break;case 36:this.store.forwardAppliedOperations&&(h=[],h.push({struct:"Delete",target:[c[0],c[1]],length:c[2]}),this.store.y.connector.broadcastOps(h));case 37:o++,e.next=12;break;case 40:case"end":return e.stop()}},e,this)})},{key:"isGarbageCollected",value:x.mark(function e(t){var r;return x.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.delegateYield(this.ds.findWithUpperBound(t),"t0",1);case 1:return r=e.t0,e.abrupt("return",null!=r&&r.id[0]===t[0]&&t[1]<r.id[1]+r.len&&r.gc);case 3:case"end":return e.stop()}},e,this)})},{key:"getDeleteSet",value:x.mark(function e(){var t;return x.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t={},e.delegateYield(this.ds.iterate(this,null,null,x.mark(function e(r){var n,i,s,a,o;return x.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:n=r.id[0],i=r.id[1],s=r.len,a=r.gc,o=t[n],void 0===o&&(o=[],t[n]=o),o.push([i,s,a]);case 7:case"end":return e.stop()}},e,this)})),"t0",2);case 2:return e.abrupt("return",t);case 3:case"end":return e.stop()}},e,this)})},{key:"isDeleted",value:x.mark(function e(t){var r;return x.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.delegateYield(this.ds.findWithUpperBound(t),"t0",1);case 1:return r=e.t0,e.abrupt("return",null!=r&&r.id[0]===t[0]&&t[1]<r.id[1]+r.len);case 3:case"end":return e.stop()}},e,this)})},{key:"setOperation",value:x.mark(function e(t){return x.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.delegateYield(this.os.put(t),"t0",1);case 1:return e.abrupt("return",t);case 2:case"end":return e.stop()}},e,this)})},{key:"addOperation",value:x.mark(function e(t){return x.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.delegateYield(this.os.put(t),"t0",1);case 1:this.store.y.connector.isSynced&&this.store.forwardAppliedOperations&&"string"!=typeof t.id[1]&&this.store.y.connector.broadcastOps([t]);case 2:case"end":return e.stop()}},e,this)})},{key:"tryCombineWithLeft",value:x.mark(function t(r){var n;return x.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(null==r||null==r.left||null==r.content||r.left[0]!==r.id[0]||!e.utils.compareIds(r.left,r.origin)){t.next=9;break}return t.delegateYield(this.getInsertion(r.left),"t0",2);case 2:if(n=t.t0,null==n.content||n.id[1]+n.content.length!==r.id[1]||1!==n.originOf.length||n.gc||n.deleted||r.gc||r.deleted){t.next=9;break}return null!=r.originOf?n.originOf=r.originOf:delete n.originOf,n.content=n.content.concat(r.content),n.right=r.right,t.delegateYield(this.os.delete(r.id),"t1",8);case 8:return t.delegateYield(this.setOperation(n),"t2",9);case 9:case"end":return t.stop()}},t,this)})},{key:"getInsertion",value:x.mark(function e(t){var r,n;return x.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.delegateYield(this.os.findWithUpperBound(t),"t0",1);case 1:if(null!=(r=e.t0)){e.next=6;break}return e.abrupt("return",null);case 6:if(n=null!=r.content?r.content.length:1,!(t[0]===r.id[0]&&t[1]<r.id[1]+n)){e.next=11;break}return e.abrupt("return",r);case 11:return e.abrupt("return",null);case 12:case"end":return e.stop()}},e,this)})},{key:"getInsertionCleanStartEnd",value:x.mark(function e(t){return x.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.delegateYield(this.getInsertionCleanStart(t),"t0",1);case 1:return e.delegateYield(this.getInsertionCleanEnd(t),"t1",2);case 2:return e.abrupt("return",e.t1);case 3:case"end":return e.stop()}},e,this)})},{key:"getInsertionCleanStart",value:x.mark(function t(r){var n,i,s;return x.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.delegateYield(this.getInsertion(r),"t0",1);case 1:if(null==(n=t.t0)){t.next=21;break}if(n.id[1]!==r[1]){t.next=7;break}return t.abrupt("return",n);case 7:return i=e.utils.copyObject(n),n.content=i.content.splice(r[1]-n.id[1]),n.id=r,s=e.utils.getLastId(i),n.origin=s,i.originOf=[n.id],i.right=n.id,n.left=s,t.delegateYield(this.setOperation(i),"t1",16);case 16:return t.delegateYield(this.setOperation(n),"t2",17);case 17:return i.gc&&this.store.queueGarbageCollector(n.id),t.abrupt("return",n);case 19:t.next=22;break;case 21:return t.abrupt("return",null);case 22:case"end":return t.stop()}},t,this)})},{key:"getInsertionCleanEnd",value:x.mark(function t(r){var n,i,s;return x.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.delegateYield(this.getInsertion(r),"t0",1);case 1:if(null==(n=t.t0)){t.next=21;break}if(null!=n.content&&n.id[1]+n.content.length-1!==r[1]){t.next=7;break}return t.abrupt("return",n);case 7:return i=e.utils.copyObject(n),i.content=n.content.splice(r[1]-n.id[1]+1),i.id=[r[0],r[1]+1],s=e.utils.getLastId(n),i.origin=s,n.originOf=[i.id],n.right=i.id,i.left=s,t.delegateYield(this.setOperation(i),"t1",16);case 16:return t.delegateYield(this.setOperation(n),"t2",17);case 17:return n.gc&&this.store.queueGarbageCollector(i.id),t.abrupt("return",n);case 19:t.next=22;break;case 21:return t.abrupt("return",null);case 22:case"end":return t.stop()}},t,this)})},{key:"getOperation",value:x.mark(function t(r){var n,i,s,a;return x.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.delegateYield(this.os.find(r),"t0",1);case 1:if(n=t.t0,"_"===r[0]&&null==n){t.next=6;break}return t.abrupt("return",n);case 6:if(i=r[1].split("_"),!(i.length>1)){t.next=15;break}return s=i[0],a=e.Struct[s].create(r),a.type=i[1],t.delegateYield(this.setOperation(a),"t1",12);case 12:return t.abrupt("return",a);case 15:throw new Error("Unexpected case. Operation cannot be generated correctly!Incompatible Yjs version?");case 16:case"end":return t.stop()}},t,this)})},{key:"removeOperation",value:x.mark(function e(t){return x.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.delegateYield(this.os.delete(t),"t0",1);case 1:case"end":return e.stop()}},e,this)})},{key:"setState",value:x.mark(function e(t){var r;return x.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r={id:[t.user],clock:t.clock},e.delegateYield(this.ss.put(r),"t0",2);case 2:case"end":return e.stop()}},e,this)})},{key:"getState",value:x.mark(function e(t){var r,n;return x.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.delegateYield(this.ss.find([t]),"t0",1);case 1:return r=e.t0,n=null==r?null:r.clock,null==n&&(n=0),e.abrupt("return",{user:t,clock:n});case 5:case"end":return e.stop()}},e,this)})},{key:"getStateVector",value:x.mark(function e(){var t;return x.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=[],e.delegateYield(this.ss.iterate(this,null,null,x.mark(function e(r){return x.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:t.push({user:r.id[0],clock:r.clock});case 1:case"end":return e.stop()}},e,this)})),"t0",2);case 2:return e.abrupt("return",t);case 3:case"end":return e.stop()}},e,this)})},{key:"getStateSet",value:x.mark(function e(){var t;return x.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t={},e.delegateYield(this.ss.iterate(this,null,null,x.mark(function e(r){return x.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:t[r.id[0]]=r.clock;case 1:case"end":return e.stop()}},e,this)})),"t0",2);case 2:return e.abrupt("return",t);case 3:case"end":return e.stop()}},e,this)})},{key:"getOperations",value:x.mark(function t(r){var n,i,s,a,o,c,u,l,d,h,f,p,g,y,v,b,k,m,w;return x.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return null==r&&(r={}),n=[],t.delegateYield(this.getStateVector(),"t0",3);case 3:i=t.t0,s=!0,a=!1,o=void 0,t.prev=7,c=i[Symbol.iterator]();case 9:if(s=(u=c.next()).done){t.next=23;break}if(l=u.value,"_"!==(d=l.user)){t.next=14;break}return t.abrupt("continue",20);case 14:if(!((h=r[d]||0)>0)){t.next=19;break}return t.delegateYield(this.getInsertion([d,h]),"t1",17);case 17:null!=(f=t.t1)&&(h=f.id[1]);case 19:r[d]=h;case 20:s=!0,t.next=9;break;case 23:t.next=29;break;case 25:t.prev=25,t.t2=t.catch(7),a=!0,o=t.t2;case 29:t.prev=29,t.prev=30,!s&&c.return&&c.return();case 32:if(t.prev=32,!a){t.next=35;break}throw o;case 35:return t.finish(32);case 36:return t.finish(29);case 37:p=!0,g=!1,y=void 0,t.prev=40,v=i[Symbol.iterator]();case 42:if(p=(b=v.next()).done){t.next=52;break}if(k=b.value,m=k.user,w=r[m],"_"!==m){t.next=48;break}return t.abrupt("continue",49);case 48:return t.delegateYield(this.os.iterate(this,[m,w],[m,Number.MAX_VALUE],x.mark(function t(i){var s,a,o,c;return x.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(i=e.Struct[i.struct].encode(i),"Insert"===i.struct){t.next=5;break}n.push(i),t.next=40;break;case 5:if(!(null==i.right||i.right[1]<(r[i.right[0]]||0))){t.next=40;break}s=i,a=[i],o=i.right;case 9:if(null!=s.left){t.next=14;break}return i.left=null,n.push(i),t.abrupt("break",40);case 14:return t.delegateYield(this.getInsertion(s.left),"t0",15);case 15:for(s=t.t0;a.length>0&&e.utils.matchesId(s,a[a.length-1].origin);)a.pop();if(!(s.id[1]<(r[s.id[0]]||0))){t.next=23;break}return i.left=e.utils.getLastId(s),n.push(i),t.abrupt("break",40);case 23:if(!e.utils.matchesId(s,i.origin)){t.next=33;break}if(i.left=i.origin,n.push(i),i=e.Struct[i.struct].encode(s),i.right=o,!(a.length>0)){t.next=30;break}throw new Error("Reached inconsistent OS state.Operations are not correctly connected.");case 30:a=[i],t.next=38;break;case 33:c=e.Struct[i.struct].encode(s),c.right=a[a.length-1].id,c.left=c.origin,n.push(c),a.push(s);case 38:t.next=9;break;case 40:case"end":return t.stop()}},t,this)})),"t3",49);case 49:p=!0,t.next=42;break;case 52:t.next=58;break;case 54:t.prev=54,t.t4=t.catch(40),g=!0,y=t.t4;case 58:t.prev=58,t.prev=59,!p&&v.return&&v.return();case 61:if(t.prev=61,!g){t.next=64;break}throw y;case 64:return t.finish(61);case 65:return t.finish(58);case 66:return t.abrupt("return",n.reverse());case 67:case"end":return t.stop()}},t,this,[[7,25,29,37],[30,,32,36],[40,54,58,66],[59,,61,65]])})},{key:"getOperationsUntransformed",value:x.mark(function e(){var t;return x.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=[],e.delegateYield(this.os.iterate(this,null,null,x.mark(function e(r){return x.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:"_"!==r.id[0]&&t.push(r);case 1:case"end":return e.stop()}},e,this)})),"t0",2);case 2:return e.abrupt("return",{untransformed:t});case 3:case"end":return e.stop()}},e,this)})},{key:"applyOperationsUntransformed",value:x.mark(function t(r,n){var i,s,a,o,c,u;return x.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:i=r.untransformed,s=0;case 2:if(!(s<i.length)){t.next=23;break}if(a=i[s],null==a.parent||"_"!==a.parent[0]){t.next=19;break}if("Insert"!==a.struct){t.next=19;break}if(null==a.parentSub||null!=a.left){t.next=13;break}return t.delegateYield(this.getOperation(a.parent),"t0",8);case 8:return o=t.t0,o.map[a.parentSub]=a.id,t.delegateYield(this.setOperation(o),"t1",11);case 11:t.next=19;break;case 13:if(null!=a.right&&null!=a.left){t.next=19;break}return t.delegateYield(this.getOperation(a.parent),"t2",15);case 15:return c=t.t2,null==a.right&&(c.end=e.utils.getLastId(a)),null==a.left&&(c.start=a.id),t.delegateYield(this.setOperation(c),"t3",19);case 19:return t.delegateYield(this.os.put(a),"t4",20);case 20:s++,t.next=2;break;case 23:t.t5=x.keys(n);case 24:if((t.t6=t.t5()).done){t.next=29;break}return u=t.t6.value,t.delegateYield(this.ss.put({id:[u],clock:n[u]}),"t7",27);case 27:t.next=24;break;case 29:case"end":return t.stop()}},t,this)})},{key:"flush",value:x.mark(function e(){return x.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.delegateYield(this.os.flush(),"t0",1);case 1:return e.delegateYield(this.ss.flush(),"t1",2);case 2:return e.delegateYield(this.ds.flush(),"t2",3);case 3:case"end":return e.stop()}},e,this)})}]),t}();e.Transaction=t}(c),function(e){var t={Delete:{encode:function(e){return{target:e.target,length:e.length||0,struct:"Delete"}},requiredOps:function(e){return[]},execute:x.mark(function e(t){return x.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.delegateYield(this.deleteOperation(t.target,t.length||1),"t0",1);case 1:return e.abrupt("return",e.t0);case 2:case"end":return e.stop()}},e,this)})},Insert:{encode:function(e){var t={id:e.id,left:e.left,right:e.right,origin:e.origin,parent:e.parent,struct:e.struct};return null!=e.parentSub&&(t.parentSub=e.parentSub),e.hasOwnProperty("opContent")?t.opContent=e.opContent:t.content=e.content.slice(),t},requiredOps:function(t){var r=[];return null!=t.left&&r.push(t.left),null!=t.right&&r.push(t.right),null==t.origin||e.utils.compareIds(t.left,t.origin)||r.push(t.origin),r.push(t.parent),null!=t.opContent&&r.push(t.opContent),r},getDistanceToOrigin:x.mark(function t(r){var n,i;return x.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(null!=r.left){t.next=4;break}return t.abrupt("return",0);case 4:return n=0,t.delegateYield(this.getInsertion(r.left),"t0",6);case 6:i=t.t0;case 7:if(e.utils.matchesId(i,r.origin)){t.next=17;break}if(n++,null!=i.left){t.next=13;break}return t.abrupt("break",17);case 13:return t.delegateYield(this.getInsertion(i.left),"t1",14);case 14:i=t.t1;case 15:t.next=7;break;case 17:return t.abrupt("return",n);case 18:case"end":return t.stop()
}},t,this)}),execute:x.mark(function r(n){var i,s,a,o,c,u,l,d,h,f,p,g;return x.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:if(s=[],null==n.origin){r.next=8;break}return r.delegateYield(this.getInsertionCleanEnd(n.origin),"t0",3);case 3:return a=r.t0,null==a.originOf&&(a.originOf=[]),a.originOf.push(n.id),r.delegateYield(this.setOperation(a),"t1",7);case 7:null!=a.right&&s.push(a.right);case 8:return r.delegateYield(t.Insert.getDistanceToOrigin.call(this,n),"t2",9);case 9:if(o=i=r.t2,null==n.left){r.next=23;break}return r.delegateYield(this.getInsertionCleanEnd(n.left),"t3",12);case 12:if(c=r.t3,e.utils.compareIds(n.left,n.origin)||null==c.right||s.push(c.right),null!=c.right){r.next=18;break}r.t4=null,r.next=20;break;case 18:return r.delegateYield(this.getOperation(c.right),"t5",19);case 19:r.t4=r.t5;case 20:c=r.t4,r.next=34;break;case 23:return r.delegateYield(this.getOperation(n.parent),"t6",24);case 24:if(u=r.t6,null!=(d=n.parentSub?u.map[n.parentSub]:u.start)){r.next=30;break}r.t7=null,r.next=32;break;case 30:return r.delegateYield(this.getOperation(d),"t8",31);case 31:r.t7=r.t8;case 32:l=r.t7,c=l;case 34:if(null==n.right){r.next=37;break}return s.push(n.right),r.delegateYield(this.getInsertionCleanStart(n.right),"t9",37);case 37:if(null==c||e.utils.compareIds(c.id,n.right)){r.next=59;break}return r.delegateYield(t.Insert.getDistanceToOrigin.call(this,c),"t10",40);case 40:if((h=r.t10)!==i){r.next=45;break}c.id[0]<n.id[0]&&(n.left=e.utils.getLastId(c),o=i+1),r.next=50;break;case 45:if(!(h<i)){r.next=49;break}i-o<=h&&(n.left=e.utils.getLastId(c),o=i+1),r.next=50;break;case 49:return r.abrupt("break",62);case 50:if(i++,null==c.right){r.next=56;break}return r.delegateYield(this.getInsertion(c.right),"t11",53);case 53:c=r.t11,r.next=57;break;case 56:c=null;case 57:r.next=60;break;case 59:return r.abrupt("break",62);case 60:r.next=37;break;case 62:if(f=null,p=null,null!=u){r.next=67;break}return r.delegateYield(this.getOperation(n.parent),"t12",66);case 66:u=r.t12;case 67:if(null==n.left){r.next=75;break}return r.delegateYield(this.getInsertion(n.left),"t13",69);case 69:return f=r.t13,n.right=f.right,f.right=n.id,r.delegateYield(this.setOperation(f),"t14",73);case 73:r.next=76;break;case 75:n.right=n.parentSub?u.map[n.parentSub]||null:u.start;case 76:if(null==n.right){r.next=86;break}return r.delegateYield(this.getOperation(n.right),"t15",78);case 78:if(p=r.t15,p.left=e.utils.getLastId(n),null==p.gc){r.next=85;break}if(!(null!=p.content&&p.content.length>1)){r.next=84;break}return r.delegateYield(this.getInsertionCleanEnd(p.id),"t16",83);case 83:p=r.t16;case 84:this.store.removeFromGarbageCollector(p);case 85:return r.delegateYield(this.setOperation(p),"t17",86);case 86:if(null==n.parentSub){r.next=96;break}if(null!=f){r.next=90;break}return u.map[n.parentSub]=n.id,r.delegateYield(this.setOperation(u),"t18",90);case 90:if(null==n.right){r.next=92;break}return r.delegateYield(this.deleteOperation(n.right,1,!0),"t19",92);case 92:if(null==n.left){r.next=94;break}return r.delegateYield(this.deleteOperation(n.id,1,!0),"t20",94);case 94:r.next=100;break;case 96:if(null!=p&&null!=f){r.next=100;break}return null==p&&(u.end=e.utils.getLastId(n)),null==f&&(u.start=n.id),r.delegateYield(this.setOperation(u),"t21",100);case 100:i=0;case 101:if(!(i<s.length)){r.next=108;break}return r.delegateYield(this.getOperation(s[i]),"t22",103);case 103:return g=r.t22,r.delegateYield(this.tryCombineWithLeft(g),"t23",105);case 105:i++,r.next=101;break;case 108:case"end":return r.stop()}},r,this)})},List:{create:function(e){return{start:null,end:null,struct:"List",id:e}},encode:function(e){var t={struct:"List",id:e.id,type:e.type};return null!=e.requires&&(t.requires=e.requires),null!=e.info&&(t.info=e.info),t},requiredOps:function(){return[]},execute:x.mark(function e(t){return x.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:t.start=null,t.end=null;case 2:case"end":return e.stop()}},e,this)}),ref:x.mark(function e(t,r){var n,i;return x.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(null!=t.start){e.next=2;break}return e.abrupt("return",null);case 2:return n=null,e.delegateYield(this.getOperation(t.start),"t0",4);case 4:i=e.t0;case 5:if(i.deleted||(n=i,r--),!(r>=0&&null!=i.right)){e.next=12;break}return e.delegateYield(this.getOperation(i.right),"t1",9);case 9:i=e.t1,e.next=13;break;case 12:return e.abrupt("break",15);case 13:e.next=5;break;case 15:return e.abrupt("return",n);case 16:case"end":return e.stop()}},e,this)}),map:x.mark(function e(t,r){var n,i;return x.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:t=t.start,n=[];case 2:if(null==t){e.next=9;break}return e.delegateYield(this.getOperation(t),"t0",4);case 4:i=e.t0,i.deleted||n.push(r(i)),t=i.right,e.next=2;break;case 9:return e.abrupt("return",n);case 10:case"end":return e.stop()}},e,this)})},Map:{create:function(e){return{id:e,map:{},struct:"Map"}},encode:function(e){var t={struct:"Map",type:e.type,id:e.id,map:{}};return null!=e.requires&&(t.requires=e.requires),null!=e.info&&(t.info=e.info),t},requiredOps:function(){return[]},execute:x.mark(function e(){return x.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}},e,this)}),get:x.mark(function e(t,r){var n,i;return x.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(null==(n=t.map[r])){e.next=14;break}return e.delegateYield(this.getOperation(n),"t0",3);case 3:if(null!=(i=e.t0)&&!i.deleted){e.next=8;break}return e.abrupt("return",void 0);case 8:if(null!=i.opContent){e.next=12;break}return e.abrupt("return",i.content[0]);case 12:return e.delegateYield(this.getType(i.opContent),"t1",13);case 13:return e.abrupt("return",e.t1);case 14:case"end":return e.stop()}},e,this)})}};e.Struct=t}(c),function(e){function t(e){var t={};for(var r in e)t[r]=e[r];return t}function r(e){return e=t(e),null!=e.content&&(e.content=e.content.map(function(e){return e})),e}function n(e,t){return e[0]<t[0]||e[0]===t[0]&&(e[1]<t[1]||l(e[1])<l(t[1]))}function i(e,t){return e.target[0]===t[0]&&e.target[1]<=t[1]&&t[1]<e.target[1]+(e.length||1)}function s(e,t){return null==e||null==t?e===t:e[0]===t[0]&&e[1]===t[1]}function a(e,t){return null==t||null==e?t===e:t[0]===e.id[0]&&(null==e.content?t[1]===e.id[1]:t[1]>=e.id[1]&&t[1]<e.id[1]+e.content.length)}function o(e){return null==e.content||1===e.content.length?e.id:[e.id[0],e.id[1]+e.content.length-1]}function c(e){for(var t=new Array(e),r=0;r<t.length;r++)t[r]={id:[null,null]};return t}function u(e){return function(e){function t(e,r){d(this,t);var n=g(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,r));return n.writeBuffer=c(5),n.readBuffer=c(10),n}return p(t,e),h(t,[{key:"find",value:x.mark(function e(r,n){var i,s,a;return x.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:i=this.readBuffer.length-1;case 1:if(!(i>=0)){e.next=10;break}if(s=this.readBuffer[i],s.id[1]!==r[1]||s.id[0]!==r[0]){e.next=7;break}for(;i<this.readBuffer.length-1;i++)this.readBuffer[i]=this.readBuffer[i+1];return this.readBuffer[this.readBuffer.length-1]=s,e.abrupt("return",s);case 7:i--,e.next=1;break;case 10:i=this.writeBuffer.length-1;case 11:if(!(i>=0)){e.next=19;break}if(s=this.writeBuffer[i],s.id[1]!==r[1]||s.id[0]!==r[0]){e.next=16;break}return a=s,e.abrupt("break",19);case 16:i--,e.next=11;break;case 19:if(!(i<0&&void 0===n)){e.next=22;break}return e.delegateYield(f(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"find",this).call(this,r),"t0",21);case 21:a=e.t0;case 22:if(null!=a){for(i=0;i<this.readBuffer.length-1;i++)this.readBuffer[i]=this.readBuffer[i+1];this.readBuffer[this.readBuffer.length-1]=a}return e.abrupt("return",a);case 24:case"end":return e.stop()}},e,this)})},{key:"put",value:x.mark(function e(r){var n,i,s,a;return x.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:n=r.id,i=this.writeBuffer.length-1;case 2:if(!(i>=0)){e.next=11;break}if(s=this.writeBuffer[i],s.id[1]!==n[1]||s.id[0]!==n[0]){e.next=8;break}for(;i<this.writeBuffer.length-1;i++)this.writeBuffer[i]=this.writeBuffer[i+1];return this.writeBuffer[this.writeBuffer.length-1]=r,e.abrupt("break",11);case 8:i--,e.next=2;break;case 11:if(!(i<0)){e.next=17;break}if(a=this.writeBuffer[0],null===a.id[0]){e.next=15;break}return e.delegateYield(f(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"put",this).call(this,a),"t0",15);case 15:for(i=0;i<this.writeBuffer.length-1;i++)this.writeBuffer[i]=this.writeBuffer[i+1];this.writeBuffer[this.writeBuffer.length-1]=r;case 17:for(i=0;i<this.readBuffer.length-1;i++)s=this.readBuffer[i+1],s.id[1]===n[1]&&s.id[0]===n[0]?this.readBuffer[i]=r:this.readBuffer[i]=s;this.readBuffer[this.readBuffer.length-1]=r;case 19:case"end":return e.stop()}},e,this)})},{key:"delete",value:x.mark(function e(r){var n,i;return x.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:for(n=0;n<this.readBuffer.length;n++)i=this.readBuffer[n],i.id[1]===r[1]&&i.id[0]===r[0]&&(this.readBuffer[n]={id:[null,null]});return e.delegateYield(this.flush(),"t0",2);case 2:return e.delegateYield(f(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"delete",this).call(this,r),"t1",3);case 3:case"end":return e.stop()}},e,this)})},{key:"findWithLowerBound",value:x.mark(function e(r){var n,i=arguments;return x.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.delegateYield(this.find(r,!0),"t0",1);case 1:if(null==(n=e.t0)){e.next=6;break}return e.abrupt("return",n);case 6:return e.delegateYield(this.flush(),"t1",7);case 7:return e.delegateYield(f(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"findWithLowerBound",this).apply(this,i),"t2",8);case 8:return e.abrupt("return",e.t2);case 9:case"end":return e.stop()}},e,this)})},{key:"findWithUpperBound",value:x.mark(function e(r){var n,i=arguments;return x.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.delegateYield(this.find(r,!0),"t0",1);case 1:if(null==(n=e.t0)){e.next=6;break}return e.abrupt("return",n);case 6:return e.delegateYield(this.flush(),"t1",7);case 7:return e.delegateYield(f(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"findWithUpperBound",this).apply(this,i),"t2",8);case 8:return e.abrupt("return",e.t2);case 9:case"end":return e.stop()}},e,this)})},{key:"findNext",value:x.mark(function e(){var r=arguments;return x.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.delegateYield(this.flush(),"t0",1);case 1:return e.delegateYield(f(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"findNext",this).apply(this,r),"t1",2);case 2:return e.abrupt("return",e.t1);case 3:case"end":return e.stop()}},e,this)})},{key:"findPrev",value:x.mark(function e(){var r=arguments;return x.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.delegateYield(this.flush(),"t0",1);case 1:return e.delegateYield(f(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"findPrev",this).apply(this,r),"t1",2);case 2:return e.abrupt("return",e.t1);case 3:case"end":return e.stop()}},e,this)})},{key:"iterate",value:x.mark(function e(){var r=arguments;return x.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.delegateYield(this.flush(),"t0",1);case 1:return e.delegateYield(f(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"iterate",this).apply(this,r),"t1",2);case 2:case"end":return e.stop()}},e,this)})},{key:"flush",value:x.mark(function e(){var r,n;return x.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:r=0;case 1:if(!(r<this.writeBuffer.length)){e.next=9;break}if(n=this.writeBuffer[r],null===n.id[0]){e.next=6;break}return e.delegateYield(f(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"put",this).call(this,n),"t0",5);case 5:this.writeBuffer[r]={id:[null,null]};case 6:r++,e.next=1;break;case 9:case"end":return e.stop()}},e,this)})}]),t}(e)}function y(e){return e?(e^16*Math.random()>>e/4).toString(16):([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,y)}e.utils={},e.utils.bubbleEvent=function(e,t){for(e.eventHandler.callEventListeners(t),t.path=[];null!=e&&null!=e._deepEventHandler;){e._deepEventHandler.callEventListeners(t);var r=null;null!=e._parent&&(r=e.os.getType(e._parent)),null!=r&&null!=r._getPathToChild?(t.path=[r._getPathToChild(e._model)].concat(t.path),e=r):e=null}};var v=function(){function e(){d(this,e),this._eventListener={}}return h(e,[{key:"on",value:function(e,t){null==this._eventListener[e]&&(this._eventListener[e]=[]),this._eventListener[e].push(t)}},{key:"off",value:function(e,t){if(null==e||null==t)throw new Error("You must specify event name and function!");var r=this._eventListener[e]||[];this._eventListener[e]=r.filter(function(e){return e!==t})}},{key:"emit",value:function(e,t){(this._eventListener[e]||[]).forEach(function(e){return e(t)})}},{key:"destroy",value:function(){this._eventListener=null}}]),e}();e.utils.NamedEventHandler=v;var b=function(){function e(){d(this,e),this.eventListeners=[]}return h(e,[{key:"destroy",value:function(){this.eventListeners=null}},{key:"addEventListener",value:function(e){this.eventListeners.push(e)}},{key:"removeEventListener",value:function(e){this.eventListeners=this.eventListeners.filter(function(t){return e!==t})}},{key:"removeAllEventListeners",value:function(){this.eventListeners=[]}},{key:"callEventListeners",value:function(e){for(var t=0;t<this.eventListeners.length;t++)try{var r={};for(var n in e)r[n]=e[n];this.eventListeners[t](r)}catch(e){console.error(e)}}}]),e}();e.utils.EventListenerHandler=b;var k=function(t){function r(e){d(this,r);var t=g(this,(r.__proto__||Object.getPrototypeOf(r)).call(this));return t.waiting=[],t.awaiting=0,t.onevent=e,t}return p(r,t),h(r,[{key:"destroy",value:function(){f(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"destroy",this).call(this),this.waiting=null,this.onevent=null}},{key:"receivedOp",value:function(e){if(this.awaiting<=0)this.onevent(e);else if("Delete"===e.struct){var t=this;null==e.key?function e(r){if(null==r.length)throw new Error("This shouldn't happen! d.length must be defined!");for(var n=0;n<t.waiting.length;n++){var i=t.waiting[n];if("Insert"===i.struct&&i.id[0]===r.target[0]){var s=i.hasOwnProperty("content")?i.content.length:1,a=r.target[1],o=r.target[1]+(r.length||1),c=i.id[1],u=i.id[1]+s;if(u<=a||o<=c)continue;if(c<a){if(a<u){if(u<o){i.content.splice(a-c),r.length=o-u,r.target=[r.target[0],u];continue}if(u===o)return void i.content.splice(a-c);var l={id:[i.id[0],o],content:i.content.slice(o-c),struct:"Insert"};return t.waiting.push(l),void i.content.splice(a-c)}}else{if(a===c){if(u<o){r.length=o-u,r.target=[r.target[0],u],i.content=[];continue}return u===o?void t.waiting.splice(n,1):(i.content=i.content.slice(o-c),void(i.id=[i.id[0],o]))}if(c<o){if(u<o)return t.waiting.splice(n,1),e({target:[r.target[0],a],length:c-a,struct:"Delete"}),void e({target:[r.target[0],u],length:u-o,struct:"Delete"});if(u===o){t.waiting.splice(n,1),n--,r.length-=s;continue}r.length=c-a,i.content.splice(0,o-c),i.id=[i.id[0],o];continue}}}}t.waiting.push(r)}(e):this.waiting.push(e)}else this.waiting.push(e)}},{key:"awaitAndPrematurelyCall",value:function(t){this.awaiting++,t.map(e.utils.copyOperation).forEach(this.onevent)}},{key:"awaitOps",value:x.mark(function t(r,n,i){var s,a,o,c,u,l,d,h,f;return x.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return s=function(t){for(var r=[];t.length>0;)for(var n=0;n<t.length;n++){for(var i=!0,s=0;s<t.length;s++)if(e.utils.matchesId(t[s],t[n].left)){i=!1;break}i&&(r.push(t.splice(n,1)[0]),n--)}return r},a=this.waiting.length,t.delegateYield(n.apply(r,i),"t0",3);case 3:if(this.waiting.splice(a),this.awaiting>0&&this.awaiting--,!(0===this.awaiting&&this.waiting.length>0)){t.next=70;break}o=0;case 7:if(!(o<this.waiting.length)){t.next=41;break}if(c=this.waiting[o],"Insert"!==c.struct){t.next=38;break}return t.delegateYield(r.getInsertion(c.id),"t1",11);case 11:if(u=t.t1,null==u.parentSub||null==u.left){t.next=17;break}this.waiting.splice(o,1),o--,t.next=38;break;case 17:if(e.utils.compareIds(u.id,c.id)){t.next=21;break}c.left=[c.id[0],c.id[1]-1],t.next=38;break;case 21:if(null!=u.left){t.next=25;break}c.left=null,t.next=38;break;case 25:return t.delegateYield(r.getInsertion(u.left),"t2",26);case 26:l=t.t2;case 27:if(null==l.deleted){t.next=37;break}if(null==l.left){t.next=33;break}return t.delegateYield(r.getInsertion(l.left),"t3",30);case 30:l=t.t3,t.next=35;break;case 33:return l=null,t.abrupt("break",37);case 35:t.next=27;break;case 37:c.left=null!=l?e.utils.getLastId(l):null;case 38:o++,t.next=7;break;case 41:if(null!=this._pullChanges&&this._pullChanges(),0!==this.awaiting){t.next=70;break}d=[],h=[],this.waiting.forEach(function(e){"Delete"===e.struct?h.push(e):d.push(e)}),this.waiting=[],d=s(d),f=0;case 49:if(!(f<d.length)){t.next=59;break}if(0!==this.awaiting){t.next=54;break}this.onevent(d[f]),t.next=56;break;case 54:return this.waiting=this.waiting.concat(d.slice(f)),t.abrupt("break",59);case 56:f++,t.next=49;break;case 59:f=0;case 60:if(!(f<h.length)){t.next=70;break}if(0!==this.awaiting){t.next=65;break}this.onevent(h[f]),t.next=67;break;case 65:return this.waiting=this.waiting.concat(h.slice(f)),t.abrupt("break",70);case 67:f++,t.next=60;break;case 70:case"end":return t.stop()}},t,this)})},{key:"awaitedInserts",value:function(t){for(var r=this.waiting.splice(this.waiting.length-t),n=0;n<r.length;n++){var i=r[n];if("Insert"!==i.struct)throw new Error("Expected Insert Operation!");for(var s=this.waiting.length-1;s>=0;s--){var a=this.waiting[s];"Insert"===a.struct&&(e.utils.matchesId(a,i.left)?(a.right=i.id,i.left=a.left):e.utils.compareIds(a.id,i.right)&&(a.left=e.utils.getLastId(i),i.right=a.right))}}this._tryCallEvents(t)}},{key:"awaitedDeletes",value:function(t,r){for(var n=this.waiting.splice(this.waiting.length-t),i=0;i<n.length;i++){var s=n[i];if("Delete"!==s.struct)throw new Error("Expected Delete Operation!");if(null!=r)for(var a=0;a<this.waiting.length;a++){var o=this.waiting[a];"Insert"===o.struct&&e.utils.compareIds(s.target,o.left)&&(o.left=r)}}this._tryCallEvents(t)}},{key:"_tryCallEvents",value:function(){if(this.awaiting>0&&this.awaiting--,0===this.awaiting&&this.waiting.length>0){var t=[],r=[];this.waiting.forEach(function(e){"Delete"===e.struct?r.push(e):t.push(e)}),t=function(t){for(var r=[];t.length>0;)for(var n=0;n<t.length;n++){for(var i=!0,s=0;s<t.length;s++)if(e.utils.matchesId(t[s],t[n].left)){i=!1;break}i&&(r.push(t.splice(n,1)[0]),n--)}return r}(t),t.forEach(this.onevent),r.forEach(this.onevent),this.waiting=[]}}}]),r}(b);e.utils.EventHandler=k;var m=function(){function e(){d(this,e)}return h(e,[{key:"getPath",value:function(){var e=null;if(null!=this._parent&&(e=this.os.getType(this._parent)),null!=e&&null!=e._getPathToChild){var t=e._getPathToChild(this._model),r=e.getPath();return r.push(t),r}return[]}}]),e}();e.utils.CustomType=m;var w=function e(t){if(d(this,e),null==t.struct||null==t.initType||null==t.class||null==t.name||null==t.createType)throw new Error("Custom type was not initialized correctly!");this.struct=t.struct,this.initType=t.initType,this.createType=t.createType,this.class=t.class,this.name=t.name,null!=t.appendAdditionalInfo&&(this.appendAdditionalInfo=t.appendAdditionalInfo),this.parseArguments=(t.parseArguments||function(){return[this]}).bind(this),this.parseArguments.typeDefinition=this};e.utils.CustomTypeDefinition=w,e.utils.isTypeDefinition=function(t){if(null!=t){if(t instanceof e.utils.CustomTypeDefinition)return[t];if(t.constructor===Array&&t[0]instanceof e.utils.CustomTypeDefinition)return t;if(t instanceof Function&&t.typeDefinition instanceof e.utils.CustomTypeDefinition)return[t.typeDefinition]}return!1},e.utils.copyObject=t,e.utils.copyOperation=r,e.utils.smaller=n,e.utils.inDeletionRange=i,e.utils.compareIds=s,e.utils.matchesId=a,e.utils.getLastId=o,e.utils.createSmallLookupBuffer=u,e.utils.generateGuid=y}(c),c.debug=C;var _={};c.requiringModules=_,c.extend=function(e,t){if(2===arguments.length&&"string"==typeof e)t instanceof c.utils.CustomTypeDefinition?c[e]=t.parseArguments:c[e]=t,null!=_[e]&&(_[e].resolve(),delete _[e]);else for(var r=0;r<arguments.length;r++){var n=arguments[r];if("function"!=typeof n)throw new Error("Expected function!");n(c)}},c.requestModules=o;var E=function(e){function t(e,r){d(this,t);var n=g(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return n.options=e,n.db=new c[e.db.name](n,e.db),n.connector=new c[e.connector.name](n,e.connector),n.connected=!0,n}return p(t,e),h(t,[{key:"init",value:function(e){var t=this.options,r={};this.share=r,this.db.requestTransaction(x.mark(function n(){var i,s,a,o,u,l,d;return x.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:n.t0=x.keys(t.share);case 1:if((n.t1=n.t0()).done){n.next=26;break}if(i=n.t1.value,s=t.share[i].split("("),a=s.splice(0,1),o=c[a],u=o.typeDefinition,l=["_",u.struct+"_"+a+"_"+i+"_"+s],d=[],1!==s.length){n.next=22;break}n.prev=10,d=JSON.parse("["+s[0].split(")")[0]+"]"),n.next=17;break;case 14:throw n.prev=14,n.t2=n.catch(10),new Error("Was not able to parse type definition! (share."+i+")");case 17:if(null!=o.typeDefinition.parseArguments){n.next=21;break}throw new Error(a+" does not expect arguments!");case 21:d=u.parseArguments(d[0])[1];case 22:return n.delegateYield(this.store.initType.call(this,l,d),"t3",23);case 23:r[i]=n.t3,n.next=1;break;case 26:this.store.whenTransactionsFinished().then(e);case 27:case"end":return n.stop()}},n,this,[[10,14]])}))}},{key:"isConnected",value:function(){return this.connector.isSynced}},{key:"disconnect",value:function(){return this.connected?(this.connected=!1,this.connector.disconnect()):Promise.resolve()}},{key:"reconnect",value:function(){return this.connected?Promise.resolve():(this.connected=!0,this.connector.reconnect())}},{key:"destroy",value:function(){var e=this,r=this;return this.close().then(function(){return null!=r.db.deleteDB?r.db.deleteDB():Promise.resolve()}).then(function(){f(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"destroy",e).call(e)})}},{key:"close",value:function(){var e=this;return this.share=null,null!=this.connector.destroy?this.connector.destroy():this.connector.disconnect(),this.db.whenTransactionsFinished().then(function(){return e.db.destroyTypes(),e.db.requestTransaction(x.mark(function t(){return x.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.delegateYield(e.db.destroy(),"t0",1);case 1:case"end":return t.stop()}},t,this)})),e.db.whenTransactionsFinished()})}}]),t}(c.utils.NamedEventHandler);return c});
//# sourceMappingURL=y.js.map
